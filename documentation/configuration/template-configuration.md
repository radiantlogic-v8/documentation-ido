# Configuration Templates

The page [pipeline_configuration](./pipeline-configuration.md) lists the core configuration options available for defining graph pipelines. A template is a piece of reusable configuration that can be referenced by the main templated configuration.
The ultimate purpose of a template is to ship predefined graph pipeline configurations for known and supported out-of-the-box backends like SailPoint, Entra ID, etc.

## System templates

System templates are automatically generated by the orchestrator to support predefined pieces of configurations. As of today, the orchestrator exposes 1 system template called [**functions_v1**](./functions.md)  which contains the signatures of all computed attribute functions supported by the system.

## Manage templates

When submitting a template, the system will validate it according to the version specified in the template. For instance, if you submit a template tagged with version v1, with a computed attribute function that doesn't exist in the **functions_v1** template, the submission will fail. Templates and the templated configuration must use the same version.
We currently support version v1.

## Write a templated configuration

The templated configuration is a yaml that contains references to templates with an overload of configuration option and extra vertices and/or edges definitions.
In this example 2 templates are referenced to reuse predefined configurations for 2 types of identity backends, they are called **hr_db** and **ad_db**.
The **template-overload** is used to override the templates with environment specific settings.
An additional edges linking the 2 backend templates is also defined.

```yaml title="templated_configuration_example.yaml"
version: v1
  templates:
  # if not listed, the function template is automatically added to the configuration based on its version
  - ref: hr_db
    template-overload: # the template overload section is optional and can be used to overload the template configuration
      source-objects:
        - name: hr_people
          datasource: acme # we are specifying the datasource name specific to our env, since the template uses a default one
        - name: hr_org
          datasource: acme
  - ref: ad_db
    template-overload:
      source-objects:
        - name: ad_users
          datasource: acme
          meta-attributes:
            - name: emailDomain
              literal: "@acme.com"
          computed-attributes: # adding a extra layer of logic on top of the template
            - name: mail
              function: concat
              compute-strategy: IF_EMPTY
              fields:
                - attribute-name: sAMAccountName
                  auxiliary-attribute-names: [emailDomain]
            - name: mail
              function: normalizeValue
              fields:
                - mail
        - name: ad_groups
          datasource: acme

edges: # specifying extra edges that link the hr vertices to the ad vertices
  - name: is_owned_by
    source-vertex-name: rt_account
    target-vertex-name: rt_identity
    recon-policy:
      conflict-resolution:
        name: arrival_date_based_conflict_resolution
        date-priorities:
          - date-property-name: arrival_date
            date-selector: EARLIER_WINS
      ownership-rules-sets:
        - name: ad_ruleset
          rules:
            - name: identity2account_email_lookup
              event-sources: [hr_people]
              event-types: [INSERT, UPDATE]
              confidence-level: 5
              link-condition:
                logical-operator: AND
                predicates:
                  - field: email
                    operator: EQUALS
                    value: mail
            - name: identity2account_name_lookup
              event-sources: [hr_people]
              event-types: [INSERT, UPDATE]
              confidence-level: 3
              link-condition:
                logical-operator: AND
                predicates:
                  - field: name
                    operator: EQUALS
                    value: cn
            - name: account2identity_email_lookup
              event-sources: [ad_users]
              event-types: [INSERT, UPDATE]
              confidence-level: 5
              link-condition:
                logical-operator: AND
                predicates:
                  - field: email
                    operator: EQUALS
                    value: mail
            - name: account2identity_name_lookup
              event-sources: [ad_users]
              event-types: [INSERT, UPDATE]
              confidence-level: 3
              link-condition:
                logical-operator: AND
                predicates:
                  - field: displayname
                    operator: EQUALS
                    value: cn
```

## Apply transformations to a template

You can apply transformations to a template to reuse it with different settings. This can be useful to reuse the same template for multiple similar datasources.
Imagine you have 10 backends hosting the same database schemas, you can define 1 template and apply a transformation to configure the 10 different backends with the same graph configurations.

In the following example, the template `template2` is used twice with transformations to suffix and replace the provided list of strings defined in the original template.
The transformations currently support only `suffix` and `replace` operations and is meant to be used where the `template-overload` is not sufficient such as when an identifier needs to be replaced.

```yaml title="templated_config_with_transformations_example.yaml"
version: v1
templates:
  - ref: template1
    template-overload:
      source-objects:
        - name: ad_users
          datasource: acme
        - name: ad_groups
          datasource: acme
  - ref: template2
    template-transformation:
      - suffix:
          - iddm_users
          - iddm_groups
        with: _idx1
      - replace:
          - IDDM
        with: IDDM_1
    template-overload:
      source-objects:
        - name: iddm_users_idx1
          datasource: fid1
        - name: iddm_groups_idx1
          datasource: fid1
  - ref: template2
    template-transformation:
      template-transformations:
      - suffix:
          - iddm_users
          - iddm_groups
        with: _idx2
      - replace:
          - IDDM
        with: IDDM_2
    template-overload:
      source-objects:
        - name: iddm_users_idx2
          datasource: fid2
        - name: iddm_groups_idx2
          datasource: fid2
```

Original template used as example:

```yaml title="template2.yaml"
version: v1

source-objects:
  - name: iddm_users
    datasource: ds
    object-name: user
    backend-attributes:
      - name: cn
      - name: uuid
      - name: description
      - name: mail
      - name: createdAt
    meta-attributes:
      - name: repositoryName
        literal: IDDM
      - name: repositoryDescription
        literal: IDDM Mock server
    computed-attributes:
      - name: createdAt
        function: convertLDAPGeneralizedDateTime
        fields:
          - createdAt

  - name: iddm_groups
    datasource: ds
    object-name: group
    backend-attributes:
      - name: cn
      - name: description
      - name: member
      - name: uuid
    meta-attributes:
      - name: repositoryName
        literal: IDDM
      - name: repositoryDescription
        literal: IDDM Mock server
    computed-attributes:
      - name: membershipCreationTime
        function: getDateTimeNow

vertices:
  - name: rt_account
    linkage:
      - source-object-name: iddm_users
        vertex-uid: uuid
        properties:
          - name: name
            attribute-name: cn
          - name: description
            attribute-name: description
          - name: email
            attribute-name: mail
          - name: creation_date
            attribute-name: createdAt

  - name: rt_group
    linkage:
      - source-object-name: iddm_groups
        vertex-uid: uuid
        properties:
          - name: name
            attribute-name: cn
          - name: description
            attribute-name: description

edges:
  - name: is_in_group
    source-vertex-name: rt_account
    target-vertex-name: rt_group
    rules:
      - name: membership_based_on_members
        event-sources: [iddm_groups]
        event-types: [INSERT, UPDATE]
        properties:
          - name: created_at
            attribute-name: membershipCreationTime
        link-condition:
          logical-operator: AND
          predicates:
            - field: dn
              operator: EQUALS
              value: member
```
